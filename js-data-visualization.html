<html>
	<head>
		<meta charset="UTF-8">
		<title>Find a Farmers Market</title>
		<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
		<script src="jquery.tablesorter.js"></script>
		<style>
		#map-canvas {
			width: 90%;
			height: 50%;
			margin: auto;
		}
		</style>
	</head>
	<body>
		<div id="map-canvas">
		</div>
		<label for="state-choice">Filter by state:</label>
		<select name="state-choice" id="state-choice">
			<option value="see-all">Choose a state</option>
			<option value="Alabama">Alabama</option>
			<option value="Alaska">Alaska</option>
			<option value="Arizona">Arizona</option>
			<option value="Arkansas">Arkansas</option>
			<option value="California">California</option>
			<option value="Colorado">Colorado</option>
			<option value="Connecticut">Connecticut</option>
			<option value="Delaware">Delaware</option>
			<option value="Florida">Florida</option>
			<option value="Georgia">Georgia</option>
			<option value="Hawaii">Hawaii</option>
			<option value="Idaho">Idaho</option>
			<option value="Illinois">Illinois</option>
			<option value="Indiana">Indiana</option>
			<option value="Iowa">Iowa</option>
			<option value="Kansas">Kansas</option>
			<option value="Kentucky">Kentucky</option>
			<option value="Louisiana">Louisiana</option>
			<option value="Maine">Maine</option>
			<option value="Maryland">Maryland</option>
			<option value="Massachusetts">Massachusetts</option>
			<option value="Michigan">Michigan</option>
			<option value="Minnesota">Minnesota</option>
			<option value="Mississippi">Mississippi</option>
			<option value="Missouri">Missouri</option>
			<option value="Montana">Montana</option>
			<option value="Nebraska">Nebraska</option>
			<option value="Nevada">Nevada</option>
			<option value="New Hampshire">New Hampshire</option>
			<option value="New Jersey">New Mexico</option>
			<option value="New York">New York</option>
			<option value="North Carolina">North Carolina</option>
			<option value="North Dakota">North Dakota</option>
			<option value="Ohio">Ohio</option>
			<option value="Oklahoma">Oklahoma</option>
			<option value="Oregon">Oregon</option>
			<option value="Pennsylvania">Pennsylvania</option>
			<option value="Rhode Island">Rhode Island</option>
			<option value="South Carolina">South Carolina</option>
			<option value="South Dakota">South Dakota</option>
			<option value="Tennessee">Tennessee</option>
			<option value="Texas">Texas</option>
			<option value="Utah">Utah</option>
			<option value="Vermont">Vermont</option>
			<option value="Virginia">Virginia</option>
			<option value="Washington">Washington</option>
			<option value="West Virginia">West Virginia</option>
			<option value="Wisconsin">Wisconsin</option>
			<option value="Wyoming">Wyoming</option>
		</select>
		<table id="farmers-markets" class="tablesorter">
			<thead>
				<tr class="header">
					<th>Market</th>
					<th>City</th>
					<th>State</th>
					<th>Website</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<script>
		function initializeMap() {
			var mapOptions = {
				center: new google.maps.LatLng(40.580, -98.460),
				zoom: 3,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
		}

		function loadScript () {
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.src = "http://maps.googleapis.com/maps/api/js?key=AIzaSyDApBGGo33H0Up28xx8FwrjFjhtE_vE9k4&sensor=true&callback=initializeMap";
			document.body.appendChild(script);
		}

		window.onload = loadScript;

		$.ajax({
			url: "http://usda.iriscouch.com/farmers_markets/_design/geo/_spatiallist/geojson/full?bbox=-144,20,80,60",
			dataType: "jsonp",
			success: function(json) {
				var marketArr = json.features;
				var i;
				var maxRows = Math.min(3000, marketArr.length);
				for (var i = 0; i < maxRows; i++) {
					var marketIndex = marketArr[i];
					var marketTd = $("<td>").append(marketIndex.properties.MarketName);
					var cityTd = $("<td>").append(marketIndex.properties.City);
					var stateTd = $("<td>").append(marketIndex.properties.State);
					var websiteTd = $("<td>").append(marketIndex.properties.Website);
					var newRow = $("<tr>").append(marketTd, cityTd, stateTd, websiteTd);
					var dataVal = marketIndex.properties.State;
					var rowId = marketIndex.properties._id;
					newRow.attr("data-state", dataVal);
					newRow.attr("id", rowId);
					$("#farmers-markets").append(newRow);
				}
				$("#farmers-markets").tablesorter();
			}
		});

		$("#state-choice").change(function () {
			var filter = $("#state-choice").val();
			if (filter === "see-all") {
				$("tbody tr").show();
			} else {
				$("tbody tr").hide();
				$('tbody tr[data-state="' + filter + '"]').show();
			}
		});
		</script>
	</body>
</html>