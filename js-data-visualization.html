<html>
	<head>
		<meta charset="UTF-8">
		<title>Find a Farmers Market</title>
		<style>

		#loading {
			text-align: center;
			position: absolute;
			top: 50%;
			left: 50%;
		}
		#fixed-canvas {
			width: 60%;
			height: 95%;
			position: fixed;
			margin: 10px;
		}
		#map-canvas {
			width: 100%;
			height: 100%;
		}
		#map-canvas img {
			max-width: none;
		}
		#market-info {
			float: right;
			width: 38%;
		}
		#farmers-markets div {
			font-style: italic;
		}
		#farmers-markets div:first-line {
			font-weight: bold;
			font-style: normal;
		}
		</style>
	</head>
	<body>
		<div id="loading">
			Loading...
		</div>		
		<div id="fixed-canvas">
			<div id="map-canvas"></div>
		</div>
		<div id="market-info">
			<section id="farmers-markets">
			</section>
		</div>
		<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
		<script src="to-title-case.js"></script>
		<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
		<script src="lscache.js"></script>
		<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDApBGGo33H0Up28xx8FwrjFjhtE_vE9k4&sensor=true&callback=initializeApp"></script>
		<script>
		function initializeApp() {
			//Hide loading text and set up page headers
			$("#loading").hide();
			var pageHeader = $("<h1>").append("Best Coast Eats Local");
			$("#market-info").prepend(pageHeader);

			//Initial map setup
			var mapOptions = {
				center: new google.maps.LatLng(41.5, -119.400),
				zoom: 5,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var fmMap = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

			//Function to create markers
			function createMarker(lattitude, longitude, markerId, name) {
				var fmLatLng = new google.maps.LatLng(lattitude,longitude);
				var fmMarker = new google.maps.Marker({
					position: fmLatLng,
					title: markerId,
					icon: {
						path: google.maps.SymbolPath.CIRCLE,
						scale: 3,
						fillColor: "green",
						fillOpacity: 1,
						strokeWeight: 0
					}
				});
				fmMarker.setMap(fmMap);
				var fmInfoWindow = new google.maps.InfoWindow({
					content: name
				});
				google.maps.event.addListener(fmMarker, "click", function() {
					fmInfoWindow.open(fmMap,fmMarker);
				});
			}
		
			//Loads all farmer's market data and populates map accordingly
			function loadMarketData() {
				var key = "http://usda.iriscouch.com/farmers_markets/_design/geo/_spatiallist/geojson/full?bbox=-144,20,-114,49";
				var json = lscache.get(key);

				//Check if json file is stored in local storage, if not, ajax
				if (json) {
					processData(json);
				} else {
					fetchJSON();
				}

				//Process the JSON file and populate app accordingly
				function processData(json) {
					var marketArr = json.features;
					var i;
					for (var i = 0; i < marketArr.length; i++) {
						if (marketArr[i].properties.State == "California" || marketArr[i].properties.State == "Oregon" || marketArr[i].properties.State == "Washington") {
							if (marketArr[i].properties.City != undefined && marketArr[i].properties.State != undefined) {
								var marketIndex = marketArr[i];
								var market = marketIndex.properties.MarketName.toLowerCase().toTitleCase();
								var city = marketIndex.properties.City.toLowerCase().toTitleCase();
								var state = marketIndex.properties.State.toLowerCase().toTitleCase();
								var lat = marketIndex.properties.y;
								var lng = marketIndex.properties.x;
								var marketDivId = marketIndex.properties._id;
								var marketDiv = $("<div>").append(market + "<br>" + city + ", " + state);
								marketDiv.attr("id", marketDivId);
								marketDiv.attr("class", "well")
								marketDiv.attr("data-market", market);
								marketDiv.attr("data-state", state);
								marketDiv.attr("data-city", city);
								marketDiv.attr("data-lat", lat);
								marketDiv.attr("data-lng", lng);
								$("#farmers-markets").append(marketDiv);
								if (lat) {
									createMarker(lat, lng, marketDivId, market);
								}
							}
						}
					}
				}

				//Ajax call to fetch data
				function fetchJSON() {
						$.ajax({
						url: key,
						dataType: "jsonp",
						success: function(json) {
							processJSON(json);
							lscache.set(key, json);
						}
					});
				}
			}
			loadMarketData();
		}
		</script>
	</body>
</html>