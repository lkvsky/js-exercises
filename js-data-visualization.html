<html>
	<head>
		<meta charset="UTF-8">
		<title>Find a Farmers Market</title>
		<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
		<script src="lscache.js"></script>
		<style>
		body {
			margin: auto;
			line-height: 1.5em;
		}
		#fixed-canvas {
			width: 60%;
			min-width: 250px;
			height: 95%;
			position: fixed;
			top: 2%;
		}
		#map-canvas {
			width: 100%;
			height: 100%;
		}
		#market-info {
			float: right;
			width: 38%;
		}
		</style>
	</head>
	<body>
		<div id="market-info">
			<h1>Best Coast Eats Local</h1>
			<section id="farmers-markets">
			</section>
		</div>
		<div id="fixed-canvas">
			<div id="map-canvas">
		</div>
		</div>
		<script>
		function initializeMap() {
			var mapOptions = {
				center: new google.maps.LatLng(40.580, -119.400),
				zoom: 5,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

		}

		function loadScript () {
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.src = "http://maps.googleapis.com/maps/api/js?key=AIzaSyDApBGGo33H0Up28xx8FwrjFjhtE_vE9k4&sensor=true&callback=initializeMap";
			document.body.appendChild(script);
		}

		window.onload = loadScript;

		var key = "http://usda.iriscouch.com/farmers_markets/_design/geo/_spatiallist/geojson/full?bbox=-144,20,-114,49";
		var json = lscache.get(key);
		if (json) {
			processJSON(json);
		} else {
			fetchJSON();
		}
		function processJSON (json) {
				var marketArr = json.features;
				var i;
				for (var i = 0; i < marketArr.length; i++) {
					if (marketArr[i].properties.State == "California" || marketArr[i].properties.State == "Oregon" || marketArr[i].properties.State == "Washington") {
						var marketIndex = marketArr[i];
						var marketDiv = $("<div>").append(marketIndex.properties.MarketName);
						var city = marketIndex.properties.City;
						var state = marketIndex.properties.State;
						var cityStateDiv = $("<div>").append(city + ", " + state);
						cityStateDiv.attr("style", "font-weight: italic; font-size: .5em")
						var totalDiv = $("<div>").append(marketDiv, cityStateDiv);
						var totalDivId = marketIndex.properties._id;
						var lat = marketIndex.properties.y;
						var lng = marketIndex.properties.x;
						totalDiv.attr("data-state", state);
						totalDiv.attr("id", totalDivId);
						totalDiv.attr("lat", lat);
						totalDiv.attr("lng", lng);
						$("#farmers-markets").append(totalDiv);
					}
				}
		}
		function fetchJSON () {
				$.ajax({
				url: "http://usda.iriscouch.com/farmers_markets/_design/geo/_spatiallist/geojson/full?bbox=-144,20,-114,49",
				dataType: "jsonp",
				success: function(json) {
					processJSON(json);
					lscache.set(key, json);
				}
			});
		}
		
		</script>
	</body>
</html>