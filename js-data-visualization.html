<html>
	<head>
		<meta charset="UTF-8">
		<title>Find a Farmers Market</title>
		<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
		<script src="jquery.tablesorter.js"></script>
		<style>
		#map-canvas {
			width: 30%;
			min-width: 250px;
			height: 95%;
			position: fixed;
			top: 0%;
		}
		#market-table {
			float: right;
			width: 50%;
		}
		</style>
	</head>
	<body>
		<div id="market-table">
			<h1>Best Coast Eats Local</h1>
			<label for="state-choice">Filter by state:</label>
			<select name="state-choice" id="state-choice">
				<option value="see-all">Choose a state</option>
				<option value="California">California</option>
				<option value="Oregon">Oregon</option>
				<option value="Washington">Washington</option>
			</select>
			<table id="farmers-markets" class="tablesorter">
				<thead>
					<tr class="header">
						<th>Market</th>
						<th>City</th>
						<th>State</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<div id="map-canvas">
		</div>
		<script>
		function initializeMap() {
			var mapOptions = {
				center: new google.maps.LatLng(40.580, -119.400),
				zoom: 5,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
		}

		function loadScript () {
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.src = "http://maps.googleapis.com/maps/api/js?key=AIzaSyDApBGGo33H0Up28xx8FwrjFjhtE_vE9k4&sensor=true&callback=initializeMap";
			document.body.appendChild(script);
		}

		window.onload = loadScript;

		if (localStorage.length > 1) {
			for (var i = 0; i < localStorage.length; i++) {
				var marketLs = $("<td>").append(localStorage.getItem("market" + i));
				var cityLs = $("<td>").append(localStorage.getItem("city" + i));
				var stateLs = $("<td>").append(localStorage.getItem("state" + i));
				var rowLs = $("<tr>").append(marketLs, cityLs, stateLs);
				var stateDataVal = localStorage.getItem("state" + i);
				rowLs.attr("data-state", stateDataVal);
				$("#farmers-markets").append(rowLs);
			}
			$("#farmers-markets").tablesorter();
		} else {
			$.ajax({
			url: "http://usda.iriscouch.com/farmers_markets/_design/geo/_spatiallist/geojson/full?bbox=-144,20,-114,49",
			dataType: "jsonp",
			success: function(json) {
				var marketArr = json.features;
				var i;
				for (var i = 0; i < marketArr.length; i++) {
					if (marketArr[i].properties.State == "California" || marketArr[i].properties.State == "Oregon" || marketArr[i].properties.State == "Washington") {
						var marketIndex = marketArr[i];
						var marketTd = $("<td>").append(marketIndex.properties.MarketName);
						localStorage.setItem("market" + i, marketIndex.properties.MarketName)
						var cityTd = $("<td>").append(marketIndex.properties.City);
						localStorage.setItem("city" + i, marketIndex.properties.City);
						var stateTd = $("<td>").append(marketIndex.properties.State);
						localStorage.setItem("state" + i, marketIndex.properties.State);
						var newRow = $("<tr>").append(marketTd, cityTd, stateTd);
						var dataVal = marketIndex.properties.State;
						var rowId = marketIndex.properties._id;
						newRow.attr("data-state", dataVal);
						newRow.attr("id", rowId);
						$("#farmers-markets").append(newRow);
						var lat = marketIndex.properties.y;
						localStorage.setItem("lat" + i, marketIndex.properties.y);
						var lng = marketIndex.properties.x;
						localStorage.setItem("lng" + i, marketIndex.properties.x);
					}
				}
				$("#farmers-markets").tablesorter();
			}
		});
		}

		$("#state-choice").change(function () {
			var filter = $("#state-choice").val();
			if (filter === "see-all") {
				$("tbody tr").show();
			} else {
				$("tbody tr").hide();
				$('tbody tr[data-state="' + filter + '"]').show();
			}
		});
		</script>
	</body>
</html>